<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jersey Tax Residence Assessment Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background: white;
            min-height: 100vh;
        }
        
        .header {
            background: #C8102E;
            color: white;
            padding: 1rem 0;
        }
        
        .header-content {
            max-width: 64rem;
            margin: 0 auto;
            padding: 0 1.5rem;
        }
        
        .header h1 {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .breadcrumb {
            background: #f3f4f6;
            border-bottom: 1px solid #d1d5db;
            padding: 0.75rem 0;
        }
        
        .breadcrumb-content {
            max-width: 64rem;
            margin: 0 auto;
            padding: 0 1.5rem;
            font-size: 0.875rem;
        }
        
        .breadcrumb a {
            color: #C8102E;
            text-decoration: none;
        }
        
        .container {
            max-width: 64rem;
            margin: 0 auto;
            padding: 2rem 1.5rem;
        }
        
        .intro h2 {
            font-size: 1.875rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }
        
        .intro p {
            font-size: 1.125rem;
            color: #4b5563;
            margin-bottom: 2rem;
        }
        
        .card {
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        .question-box {
            background: #f9fafb;
            padding: 1.25rem;
            border-radius: 0.25rem;
            border: 1px solid #d1d5db;
            margin-bottom: 1.5rem;
        }
        
        .question-box h3 {
            font-size: 1.125rem;
            font-weight: bold;
            margin-bottom: 0.75rem;
        }
        
        .question-box p {
            font-size: 0.875rem;
            color: #4b5563;
        }
        
        .button-group {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .option-button {
            background: white;
            border: 2px solid #d1d5db;
            padding: 1rem 1.5rem;
            border-radius: 0.25rem;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }
        
        .option-button:hover {
            border-color: #C8102E;
            background: #fef2f2;
        }
        
        .option-button-title {
            font-weight: bold;
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }
        
        .option-button-subtitle {
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .result-box {
            border: 1px solid #93c5fd;
            padding: 1.5rem;
            border-radius: 0.25rem;
            margin-bottom: 1.5rem;
        }
        
        .result-box.non-resident {
            background: #e0e0e0;
            border-color: #555;
        }
        
        .result-box.resident-not-ordinarily {
            background: #ffe7a3;
            border-color: #b8860b;
        }
        
        .result-box.resident-ordinarily {
            background: #d3f5d3;
            border-color: #3c8c3c;
        }
        
        .result-box.multifactorial {
            background: #e0e7ff;
            border-color: #a5b4fc;
        }
        
        .result-content h3 {
            font-size: 1.125rem;
            font-weight: bold;
            margin-bottom: 0.75rem;
        }
        
        .result-status {
            background: white;
            padding: 1rem;
            border-radius: 0.25rem;
            border: 1px solid #d1d5db;
            margin-bottom: 1rem;
        }
        
        .result-status p {
            font-size: 1.25rem;
            font-weight: bold;
            color: #1f2937;
        }
        
        .result-details {
            background: #f9fafb;
            padding: 1rem;
            border-radius: 0.25rem;
            border: 1px solid #d1d5db;
        }
        
        .result-details h4 {
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .result-details p {
            margin-bottom: 1rem;
            line-height: 1.6;
        }
        
        .result-details p:last-child {
            margin-bottom: 0;
        }
        
        .result-details ul {
            margin-left: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .result-details li {
            margin-bottom: 0.5rem;
        }
        
        .primary-button {
            width: 100%;
            background: #C8102E;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.25rem;
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.2s;
        }
        
        .primary-button:hover {
            background: #a00d24;
        }
        
        .secondary-button {
            background: white;
            color: #C8102E;
            padding: 0.75rem 1.5rem;
            border: 2px solid #C8102E;
            border-radius: 0.25rem;
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
        }
        
        .secondary-button:hover {
            background: #fef2f2;
        }
        
        .button-row {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .button-row .secondary-button {
            flex: 0 0 auto;
        }
        
        .button-row .primary-button {
            flex: 1;
        }
        
        .info-box {
            background: #dbeafe;
            border: 1px solid #93c5fd;
            padding: 1.5rem;
            border-radius: 0.25rem;
        }
        
        .info-box h3 {
            font-size: 1.125rem;
            font-weight: bold;
            margin-bottom: 0.75rem;
        }
        
        .info-box ul {
            list-style: none;
        }
        
        .info-box li {
            display: block;
            margin-bottom: 0.75rem;
            font-size: 0.875rem;
        }
        
        .bullet {
            color: #C8102E;
            font-weight: bold;
            margin-right: 0.5rem;
        }
        
        .info-box a {
            color: #C8102E;
            text-decoration: underline;
        }
        
        .footer {
            background: #1f2937;
            color: white;
            padding: 2rem 0;
            margin-top: 3rem;
        }
        
        .footer-content {
            max-width: 64rem;
            margin: 0 auto;
            padding: 0 1.5rem;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>Government of Jersey</h1>
        </div>
    </div>

    <div class="breadcrumb">
        <div class="breadcrumb-content">
            <a href="#">Home</a> &gt; <a href="#">Taxes and your money</a> &gt; Tax residence assessment
        </div>
    </div>

    <div class="container">
        <div class="intro">
            <h2>Jersey Tax Residence Assessment Tool</h2>
            <p>Determine your tax residence status for Jersey income tax purposes. Your residence status determines what income you pay tax on and what allowances you receive.</p>
        </div>

        <div class="card">
            <div id="question-container"></div>
        </div>

        <div class="info-box">
            <h3>Important Information</h3>
            <ul>
                <li><span class="bullet">•</span> This tool provides guidance only. For specific advice, contact Revenue Jersey or a tax professional.</li>
                <li><span class="bullet">•</span> Double tax agreements with other jurisdictions may affect your tax position.</li>
                <li><span class="bullet">•</span> Visit <a href="https://www.gov.je/TaxesMoney/IncomeTax/Individuals/IncomeTaxCircumstances/pages/residencyforjerseytax.aspx">gov.je</a> for complete residence information.</li>
            </ul>
        </div>
    </div>

    <div class="footer">
        <div class="footer-content">
            <p>&copy; <span id="year"></span> Government of Jersey. All rights reserved.</p>
        </div>
    </div>

    <script>
        (function() {
            var state = {
                step: 'initial',
                answers: {},
                result: null,
                history: []
            };

            var questions = {
                // INITIAL ROUTING QUESTION
                initial: {
                    title: 'What is your situation?',
                    subtitle: 'Select the assessment that applies to your circumstances.',
                    options: [
                        { value: 'arrival', title: 'Determining residence for arrival year or current year', subtitle: 'I am arriving in Jersey, or assessing my status for the current or a previous tax year.' },
                        { value: 'departure', title: 'Determining residence after departure from Jersey', subtitle: 'I have left or am leaving Jersey and need to assess my status from 1 January following my departure.' }
                    ]
                },

                // ==================== ARRIVALS/ANNUAL PATHWAY ====================
                
                settled: {
                    title: 'Do you (or do you intend to) live in Jersey in a settled manner?',
                    subtitle: 'This means making Jersey your home for day-to-day life.',
                    options: [
                        { value: 'yes', title: 'Yes, Jersey is my home for day-to-day life', subtitle: 'I am moving to live here or already live here in a settled manner.' },
                        { value: 'no', title: 'No, I am visiting only or moving away', subtitle: 'I am visiting for work or leisure, or moving away from Jersey to settle abroad.' }
                    ]
                },
                
                // MOVERS BRANCH
                keepHome: {
                    title: 'Do you (or do you intend to) keep a home and significant social and economic connections outside Jersey?',
                    subtitle: 'This includes maintaining property, family ties, financial affairs, or other substantial links to another jurisdiction.',
                    options: [
                        { value: 'yes', title: 'Yes, I keep a home and connections outside Jersey', subtitle: 'I maintain a significant presence in another country.' },
                        { value: 'no', title: 'No, Jersey is my only home', subtitle: 'I have no significant home or connections elsewhere.' }
                    ]
                },
                
                fixedContract: {
                    title: 'Is your presence in Jersey further to a fixed-term employment contract of 4 years or fewer?',
                    subtitle: 'This refers to a defined contract with a specific end date within 4 years.',
                    options: [
                        { value: 'yes', title: 'Yes, fixed-term contract ≤ 4 years', subtitle: 'My employment contract has a defined end date within 4 years.' },
                        { value: 'no', title: 'No, not a fixed-term contract ≤ 4 years', subtitle: 'My contract is open-ended or exceeds 4 years.' }
                    ]
                },
                
                // VISITORS BRANCH
                sixMonths: {
                    title: 'Will you spend more than six months in Jersey in this tax year?',
                    subtitle: 'More than 183 days in the calendar year.',
                    options: [
                        { value: 'yes', title: 'Yes, more than 6 months', subtitle: 'I will spend over 183 days in Jersey.' },
                        { value: 'no', title: 'No, 6 months or fewer', subtitle: 'I will spend 183 days or fewer in Jersey.' }
                    ]
                },
                
                available: {
                    title: 'Will you spend at least one night in available accommodation?',
                    subtitle: 'Available accommodation means property you or close family own, rent, lease or have unrestricted use of — not just hotels or guest houses.',
                    options: [
                        { value: 'yes', title: 'Yes, one night in available accommodation', subtitle: 'I stay in property I or my family own/rent/have use of.' },
                        { value: 'no', title: 'No, hotels or guest houses only', subtitle: 'I only stay in hotels or guest houses.' }
                    ]
                },
                
                avgDaysHeavy: {
                    title: 'On average, how many days per annum have you spent in Jersey over the previous four years?',
                    subtitle: 'Calculate the total days over 4 years and divide by 4.',
                    options: [
                        { value: 'under90', title: '90 days or fewer per annum', subtitle: 'Average of 90 days or less over 4 years.' },
                        { value: 'over90', title: 'More than 90 days per annum', subtitle: 'Average of more than 90 days over 4 years.' }
                    ]
                },
                
                avgDaysHotels: {
                    title: 'On average, how many days per annum have you spent in Jersey over the previous four years?',
                    subtitle: 'Calculate the total days over 4 years and divide by 4. Only count visits where you stayed in hotels or guest houses.',
                    options: [
                        { value: 'under90', title: '90 days or fewer per annum', subtitle: 'Average of 90 days or less over 4 years.' },
                        { value: 'over90', title: 'More than 90 days per annum', subtitle: 'Average of more than 90 days over 4 years.' }
                    ]
                },
                
                avgDaysAccom: {
                    title: 'On average, how many days per annum have you spent in Jersey over the previous four years?',
                    subtitle: 'Calculate the total days over 4 years and divide by 4.',
                    options: [
                        { value: 'under90', title: '90 days or fewer per annum', subtitle: 'Average of 90 days or less over 4 years.' },
                        { value: 'over90', title: 'More than 90 days per annum', subtitle: 'Average of more than 90 days over 4 years.' }
                    ]
                },

                // ==================== DEPARTURES PATHWAY ====================
                
                leavingType: {
                    title: 'Are you leaving permanently or temporarily?',
                    subtitle: '',
                    options: [
                        { value: 'permanent', title: 'Permanently', subtitle: 'I am leaving Jersey to establish my home abroad permanently.' },
                        { value: 'temporary', title: 'Temporarily or unsure', subtitle: 'I may return or am uncertain about the permanence of my departure.' }
                    ]
                },
                
                cleanBreak: {
                    title: 'Have you made a clean break with Jersey before 1 January and established your home and centre of daily life abroad?',
                    subtitle: 'This means severing ties with Jersey and fully establishing yourself in another jurisdiction.',
                    options: [
                        { value: 'yes', title: 'Yes, clean break and established abroad', subtitle: 'I have fully relocated and made my home elsewhere.' },
                        { value: 'no', title: 'No, not a complete break', subtitle: 'I maintain ties to Jersey or have not fully established abroad.' }
                    ]
                },
                
                entireYear: {
                    title: 'Will you live outside Jersey for the entire (calendar) tax year?',
                    subtitle: 'With only short holiday-style visits back to Jersey.',
                    options: [
                        { value: 'yes', title: 'Yes, entire tax year abroad', subtitle: 'Only occasional holiday visits to Jersey.' },
                        { value: 'no', title: 'No, not for entire year', subtitle: 'I will be in Jersey for substantial periods.' }
                    ]
                },
                
                fullTimeEmployment: {
                    title: 'Are you in full-time employment abroad during your year of absence?',
                    subtitle: 'Duties must be conducted outside Jersey for an overseas business.',
                    options: [
                        { value: 'yes', title: 'Yes, full-time employment abroad', subtitle: 'Working full-time for an overseas employer with duties abroad.' },
                        { value: 'no', title: 'No, not in full-time employment abroad', subtitle: 'Retired, self-employed, or other arrangements.' }
                    ]
                },
                
                relinquishAccom: {
                    title: 'Have you relinquished all accommodation in Jersey?',
                    subtitle: 'No home is available for your unrestricted use — property sold, rented at arm\'s length, or genuinely not available.',
                    options: [
                        { value: 'yes', title: 'Yes, all accommodation relinquished', subtitle: 'No property available for my use in Jersey.' },
                        { value: 'no', title: 'No, accommodation remains available', subtitle: 'I still have access to property in Jersey.' }
                    ]
                }
            };

            function handleAnswer(key, value) {
                state.answers[key] = value;
                state.history.push(state.step);

                // ==================== INITIAL ROUTING ====================
                
                if (key === 'initial' && value === 'arrival') {
                    state.step = 'settled';
                    render();
                    return;
                }
                
                if (key === 'initial' && value === 'departure') {
                    state.step = 'leavingType';
                    render();
                    return;
                }

                // ==================== ARRIVALS/ANNUAL PATHWAY ====================
                
                // Q1: Settled manner?
                if (key === 'settled' && value === 'yes') {
                    state.step = 'keepHome';
                    render();
                    return;
                }
                
                if (key === 'settled' && value === 'no') {
                    state.step = 'sixMonths';
                    render();
                    return;
                }
                
                // E1: Keep home outside?
                if (key === 'keepHome' && value === 'no') {
                    state.result = {
                        status: 'Resident and Ordinarily Resident',
                        description: 'You are resident and ordinarily resident as you live in Jersey in a settled manner and do not maintain a home or significant connections elsewhere.',
                        type: 'resident-ordinarily'
                    };
                    state.step = 'result';
                    render();
                    return;
                }
                
                if (key === 'keepHome' && value === 'yes') {
                    state.step = 'fixedContract';
                    render();
                    return;
                }
                
                // F1: Fixed contract?
                if (key === 'fixedContract' && value === 'yes') {
                    state.result = {
                        status: 'Resident but Not Ordinarily Resident',
                        description: 'You are resident but not ordinarily resident as you have a fixed-term employment contract of 4 years or fewer while maintaining a home and connections outside Jersey.',
                        type: 'resident-not-ordinarily'
                    };
                    state.step = 'result';
                    render();
                    return;
                }
                
                if (key === 'fixedContract' && value === 'no') {
                    state.result = {
                        status: 'Resident and Ordinarily Resident',
                        description: 'You are resident and ordinarily resident as you do not have a fixed-term contract of 4 years or fewer while maintaining a home outside Jersey.',
                        type: 'resident-ordinarily'
                    };
                    state.step = 'result';
                    render();
                    return;
                }
                
                // D0: Six months?
                if (key === 'sixMonths' && value === 'yes') {
                    state.step = 'avgDaysHeavy';
                    render();
                    return;
                }
                
                if (key === 'sixMonths' && value === 'no') {
                    state.step = 'available';
                    render();
                    return;
                }
                
                // V3B: Average days (>6 months pathway)
                if (key === 'avgDaysHeavy' && value === 'under90') {
                    state.result = {
                        status: 'Resident but Not Ordinarily Resident',
                        description: 'You are resident but not ordinarily resident for this tax year as you spend more than 6 months in Jersey but have averaged 90 days or fewer over the previous 4 years.',
                        type: 'resident-not-ordinarily'
                    };
                    state.step = 'result';
                    render();
                    return;
                }
                
                if (key === 'avgDaysHeavy' && value === 'over90') {
                    state.result = {
                        status: 'Resident and Ordinarily Resident',
                        description: 'You are resident and ordinarily resident as you spend more than 6 months in Jersey and have averaged more than 90 days per annum over the previous 4 years.',
                        type: 'resident-ordinarily'
                    };
                    state.step = 'result';
                    render();
                    return;
                }
                
                // A1: Available accommodation?
                if (key === 'available' && value === 'no') {
                    state.step = 'avgDaysHotels';
                    render();
                    return;
                }
                
                if (key === 'available' && value === 'yes') {
                    state.step = 'avgDaysAccom';
                    render();
                    return;
                }
                
                // V3A: Hotels only average
                if (key === 'avgDaysHotels' && value === 'under90') {
                    state.result = {
                        status: 'Non-Resident',
                        description: 'You are not considered resident as you spend 6 months or fewer in Jersey, stay only in hotels or guest houses, and have averaged 90 days or fewer over the previous 4 years.',
                        type: 'non-resident'
                    };
                    state.step = 'result';
                    render();
                    return;
                }
                
                if (key === 'avgDaysHotels' && value === 'over90') {
                    state.result = {
                        status: 'Resident and Ordinarily Resident',
                        description: 'You are resident and ordinarily resident as your visits to Jersey are habitual, averaging more than 90 days per annum over the previous 4 years.',
                        type: 'resident-ordinarily'
                    };
                    state.step = 'result';
                    render();
                    return;
                }
                
                // V3: Available accommodation average
                if (key === 'avgDaysAccom' && value === 'under90') {
                    state.result = {
                        status: 'Resident but Not Ordinarily Resident',
                        description: 'You are resident but not ordinarily resident as you stay in available accommodation but have averaged 90 days or fewer over the previous 4 years.',
                        type: 'resident-not-ordinarily'
                    };
                    state.step = 'result';
                    render();
                    return;
                }
                
                if (key === 'avgDaysAccom' && value === 'over90') {
                    state.result = {
                        status: 'Resident and Ordinarily Resident',
                        description: 'You are resident and ordinarily resident as you stay in available accommodation and have averaged more than 90 days per annum over the previous 4 years.',
                        type: 'resident-ordinarily'
                    };
                    state.step = 'result';
                    render();
                    return;
                }

                // ==================== DEPARTURES PATHWAY ====================
                
                // L1: Permanent vs temporary
                if (key === 'leavingType' && value === 'permanent') {
                    state.step = 'cleanBreak';
                    render();
                    return;
                }
                
                if (key === 'leavingType' && value === 'temporary') {
                    state.step = 'entireYear';
                    render();
                    return;
                }
                
                // L1P: Clean break?
                if (key === 'cleanBreak' && value === 'yes') {
                    state.result = {
                        status: 'Non-Resident',
                        description: 'You are non-resident from 1 January following your departure as you have made a clean break with Jersey and established your home and centre of daily life abroad.',
                        type: 'non-resident'
                    };
                    state.step = 'result';
                    render();
                    return;
                }
                
                if (key === 'cleanBreak' && value === 'no') {
                    state.step = 'entireYear';
                    render();
                    return;
                }
                
                // L2: Entire year abroad?
                if (key === 'entireYear' && value === 'no') {
                    state.result = {
                        status: 'Resident and Ordinarily Resident',
                        description: 'You remain ordinarily resident as you will not be absent from Jersey for an entire tax year. Article 126 applies.',
                        type: 'resident-ordinarily'
                    };
                    state.step = 'result';
                    render();
                    return;
                }
                
                if (key === 'entireYear' && value === 'yes') {
                    state.step = 'fullTimeEmployment';
                    render();
                    return;
                }
                
                // L3: Full-time employment abroad?
                if (key === 'fullTimeEmployment' && value === 'no') {
                    state.step = 'multifactorial';
                    render();
                    return;
                }
                
                if (key === 'fullTimeEmployment' && value === 'yes') {
                    state.step = 'relinquishAccom';
                    render();
                    return;
                }
                
                // L4: Relinquish accommodation?
                if (key === 'relinquishAccom' && value === 'yes') {
                    state.result = {
                        status: 'Non-Resident',
                        description: 'You are non-resident from 1 January following your departure as you meet all three conditions for automatic non-residence: absent for an entire tax year, full-time employment abroad, and no available accommodation in Jersey.',
                        type: 'non-resident'
                    };
                    state.step = 'result';
                    render();
                    return;
                }
                
                if (key === 'relinquishAccom' && value === 'no') {
                    state.step = 'multifactorial';
                    render();
                    return;
                }
            }

            function goBack() {
                if (state.history.length > 0) {
                    state.step = state.history.pop();
                    state.result = null;
                    render();
                }
            }

            function resetQuestionnaire() {
                state = {
                    step: 'initial',
                    answers: {},
                    result: null,
                    history: []
                };
                render();
            }

            function render() {
                var container = document.getElementById('question-container');
                
                // Multifactorial assessment page
                if (state.step === 'multifactorial') {
                    container.innerHTML = 
                        '<div class="result-box multifactorial">' +
                            '<div class="result-content">' +
                                '<h3>Multifactorial Centre-of-Vital-Interests Assessment</h3>' +
                                '<div class="result-status">' +
                                    '<p>Your residence status requires further analysis</p>' +
                                '</div>' +
                                '<p style="margin-bottom: 1rem">You do not meet all three conditions for automatic non-resident status. Revenue Jersey will assess your centre of vital interests to determine whether you have established your centre of life abroad for a settled purpose.</p>' +
                                '<div class="result-details">' +
                                    '<h4>Factors considered include:</h4>' +
                                    '<ul>' +
                                        '<li>Whether your immediate family (spouse, children, dependants) continues to reside in Jersey</li>' +
                                        '<li>Whether you continue to make Jersey Social Security contributions</li>' +
                                        '<li>Whether you maintain personal effects and assets in Jersey (car, furniture in storage)</li>' +
                                        '<li>Whether you conduct your financial affairs through Jersey institutions (bank accounts, pension schemes)</li>' +
                                        '<li>The pattern of your visits to Jersey (frequent/regular vs. occasional holidaymaker)</li>' +
                                        '<li>Whether you have taken steps to establish yourself abroad in a settled manner (purchasing/renting accommodation, opening local bank accounts, registering for local tax)</li>' +
                                    '</ul>' +
                                    '<h4>Possible outcomes:</h4>' +
                                    '<p><strong>Non-Resident:</strong> If the balance of factors indicates you have established your centre of life abroad for a settled purpose, you will be treated as non-resident from 1 January following your departure. Your overseas income and Jersey-source income will be exempt from Jersey income tax (unless arising from Jersey property). For your year of departure, consult the residence assessment flowchart.</p>' +
                                    '<p><strong>Ordinarily Resident:</strong> If the balance of factors indicates your centre of vital interests remains in Jersey, you will remain ordinarily resident under Article 126. You will be liable to Jersey income tax on your worldwide income, but may claim relief for foreign taxes paid.</p>' +
                                    '<p style="margin-top: 1rem"><strong>This determination is informed by case law and Revenue Jersey practice.</strong> We recommend contacting a tax advisor or Revenue Jersey to discuss your specific circumstances.</p>' +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                        '<div class="button-row">' +
                            '<button id="back-btn" class="secondary-button">← Back</button>' +
                            '<button id="reset-btn" class="primary-button">Start New Assessment</button>' +
                        '</div>';
                    
                    document.getElementById('back-btn').addEventListener('click', goBack);
                    document.getElementById('reset-btn').addEventListener('click', resetQuestionnaire);
                    return;
                }
                
                // Result page
                if (state.step === 'result') {
                    container.innerHTML = 
                        '<div class="result-box ' + state.result.type + '">' +
                            '<div class="result-content">' +
                                '<h3>Your Tax Residence Status</h3>' +
                                '<div class="result-status">' +
                                    '<p>' + state.result.status + '</p>' +
                                '</div>' +
                                '<p style="margin-bottom: 0">' + state.result.description + '</p>' +
                            '</div>' +
                        '</div>' +
                        '<div class="button-row">' +
                            '<button id="back-btn" class="secondary-button">← Back</button>' +
                            '<button id="reset-btn" class="primary-button">Start New Assessment</button>' +
                        '</div>';
                    
                    document.getElementById('back-btn').addEventListener('click', goBack);
                    document.getElementById('reset-btn').addEventListener('click', resetQuestionnaire);
                    return;
                }

                // Question page
                var currentQuestion = questions[state.step];
                
                var html = 
                    '<div class="question-box">' +
                        '<h3>' + currentQuestion.title + '</h3>' +
                        '<p>' + currentQuestion.subtitle + '</p>' +
                    '</div>' +
                    '<div class="button-group">';

                currentQuestion.options.forEach(function(option) {
                    html += 
                        '<button class="option-button" data-step="' + state.step + '" data-value="' + option.value + '">' +
                            '<div class="option-button-title">' + option.title + '</div>' +
                            '<div class="option-button-subtitle">' + option.subtitle + '</div>' +
                        '</button>';
                });

                html += '</div>';
                
                // Add back button if not on initial question
                if (state.step !== 'initial') {
                    html += '<button id="back-btn" class="secondary-button" style="margin-top: 1.5rem;">← Back</button>';
                }
                
                container.innerHTML = html;

                // Add back button listener if present
                var backBtn = document.getElementById('back-btn');
                if (backBtn) {
                    backBtn.addEventListener('click', goBack);
                }

                var buttons = container.querySelectorAll('.option-button');
                for (var i = 0; i < buttons.length; i++) {
                    buttons[i].addEventListener('click', function(e) {
                        e.preventDefault();
                        var step = this.getAttribute('data-step');
                        var value = this.getAttribute('data-value');
                        handleAnswer(step, value);
                    });
                }
            }

            document.getElementById('year').textContent = new Date().getFullYear();
            render();
        })();
    </script>
</body>
</html>
